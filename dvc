#!/bin/bash

# dvc - Dev Container: Open VSCode Insiders in devcontainer using git clone

# Check if in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Get repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
REPO_NAME=$(basename "$REPO_ROOT")

# Generate branch name based on argument or ISO datetime
if [ $# -eq 1 ]; then
    # Extract issue number from argument (e.g., #1 -> issue-1)
    ISSUE_NUM=$(echo "$1" | sed 's/^#//')
    BRANCH_NAME="dvc-issue-${ISSUE_NUM}"
    DIR_SUFFIX="issue-${ISSUE_NUM}"
else
    # Use ISO 8601 format datetime
    ISO_DATETIME=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
    BRANCH_NAME="dvc-${ISO_DATETIME}"
    DIR_SUFFIX="${ISO_DATETIME}"
fi

CLONE_DIR="/tmp/dvc-${REPO_NAME}-${DIR_SUFFIX}"

# Get current branch
CURRENT_BRANCH=$(git branch --show-current)

echo "Creating isolated dev container..."
echo "Clone directory: $CLONE_DIR"
echo "Branch: $BRANCH_NAME"
echo "Source: $REPO_ROOT"

# Clone from the local repository
git clone "file://${REPO_ROOT}" "$CLONE_DIR"

# Change to clone directory and create new branch
cd "$CLONE_DIR"
git checkout -b "$BRANCH_NAME"

# Update origin to point to the actual remote (not the local clone source)
if ORIGIN_URL=$(cd "$REPO_ROOT" && git config --get remote.origin.url); then
    git remote set-url origin "$ORIGIN_URL"
fi

cd - > /dev/null

# Get the absolute path
CLONE_DIR=$(realpath "$CLONE_DIR")

# Encode the clone path for devcontainer URL
ENCODED_PATH=$(printf "%s" "$CLONE_DIR" | xxd -p -c 256)

# The workspace folder inside the container defaults to /workspaces/{folder-name}
CONTAINER_WORKSPACE="/workspaces/$(basename "$CLONE_DIR")"

# Open VSCode Insiders in devcontainer
echo "Opening VSCode Insiders..."
code-insiders --new-window --folder-uri "vscode-remote://dev-container+${ENCODED_PATH}${CONTAINER_WORKSPACE}" --disable-workspace-trust

echo ""
echo "Cleanup commands:"
echo "  Close VSCode, then run:"
echo "  rm -rf '$CLONE_DIR'"