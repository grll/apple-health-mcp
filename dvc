#!/bin/bash

# dvc - Dev Container: Open VSCode Insiders in devcontainer using git worktree

# Check if in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Get repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
REPO_NAME=$(basename "$REPO_ROOT")

# Generate branch name based on argument or ISO datetime
if [ $# -eq 1 ]; then
    # Extract issue number from argument (e.g., #1 -> issue-1)
    ISSUE_NUM=$(echo "$1" | sed 's/^#//')
    BRANCH_NAME="dvc-issue-${ISSUE_NUM}"
    DIR_SUFFIX="issue-${ISSUE_NUM}"
else
    # Use ISO 8601 format datetime
    ISO_DATETIME=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
    BRANCH_NAME="dvc-${ISO_DATETIME}"
    DIR_SUFFIX="${ISO_DATETIME}"
fi

WORKTREE_DIR="/tmp/dvc-${REPO_NAME}-${DIR_SUFFIX}"

echo "Creating isolated dev container..."
echo "Worktree: $WORKTREE_DIR"
echo "Branch: $BRANCH_NAME"

# Create new worktree with new branch
git worktree add -b "$BRANCH_NAME" "$WORKTREE_DIR" HEAD

# Get the absolute path
WORKTREE_DIR=$(realpath "$WORKTREE_DIR")

# Encode the worktree path for devcontainer URL
ENCODED_PATH=$(printf "%s" "$WORKTREE_DIR" | xxd -p -c 256)

# The workspace folder inside the container defaults to /workspaces/{folder-name}
CONTAINER_WORKSPACE="/workspaces/$(basename "$WORKTREE_DIR")"

# Open VSCode Insiders in devcontainer
echo "Opening VSCode Insiders..."
code-insiders --new-window --folder-uri "vscode-remote://dev-container+${ENCODED_PATH}${CONTAINER_WORKSPACE}"

echo ""
echo "Cleanup commands:"
echo "  Close VSCode, then run:"
echo "  git worktree remove '$WORKTREE_DIR'"
echo "  git branch -d '$BRANCH_NAME'"